# ROI Visualization and Annotation Tool for DICOM Mammograms

This Python application streamlines the process of browsing mammography exams in DICOM format, selecting regions of interest (ROIs), and saving those ROIs as PNG files. Metadata such as target labels and laterality are pulled from a `train.csv` file that must live inside the `archive/` directory.

## Quick Start

```powershell
PS D:\dicom_workplace> .\.venv\Scripts\activate
(.venv) PS D:\dicom_workplace> python .\src\main.py
```

## Core Features

- **DICOM Viewer** – Loads and displays DICOM images with the proper window center/width.
- **Exam Metadata** – Shows `target` (abnormality indicator) and `Laterality` for each study based on `train.csv`.
- **Navigation** –
  - Browse patient folders (Up/Down arrows).
  - Cycle through DICOMs in the current folder (Left/Right arrows).
- **ROI Selection** – Click to define the center of a 448x448 ROI; the square overlay updates live.
- **ROI Saving** – Press Enter to export the ROI as a PNG inside the exam folder; filenames auto-increment when needed.
- **Thumbnail Sidebar** – Displays previews of saved ROIs for the active exam.
- **Startup Options (console prompts)** –
  1. Back up existing PNG files and the annotation CSV.
  2. Clean all PNG files and reset the annotation CSV.
  3. Apply navigation filters (skip folders with PNGs, show only target = 0, etc.).

## Project Structure

```
dicom_workplace/
│
├── archive/                     # Patient folders (AccessionNumber) and train.csv
│   ├── 002000/
│   │   ├── image1.dcm
│   │   └── ...
│   └── train.csv
│
├── png_backups/                 # Created automatically when backups run
│   └── backup_YYYYMMDD_HHMMSS/
│       └── 002000/
│           └── image_roi.png
│
├── src/
│   ├── main.py                  # Application entry point
│   ├── ui_viewer.py             # Matplotlib UI (ImageViewerUI)
│   ├── data_manager.py          # Navigation and metadata logic
│   ├── dicom_loader.py          # DICOM loading and windowing utilities
│   ├── roi_selector.py          # ROI calculations
│   ├── utils.py                 # Backup/cleanup helpers
│   └── test.py                  # Helper to inspect DICOM dimensions
│
├── annotations.csv              # Annotation log generated by the app
├── requirements.txt             # Python dependencies
└── README.md                    # Project documentation
```

## Prerequisites

- Python 3.9 or newer (recommended)
- Dependencies listed in `requirements.txt`, including:
  - `pandas`
  - `pydicom`
  - `Pillow`
  - `matplotlib`
  - `numpy`
- For compressed DICOM support (e.g., JPEG Lossless):
  - `pylibjpeg`
  - `pylibjpeg-libjpeg`
  - Alternatively, `pip install pydicom[jpeg]`

## Environment Setup

1. **Clone the repository** (if applicable):
   ```bash
   git clone <repository_url>
   cd dicom_workplace
   ```

2. **Create a virtual environment**:
   ```bash
   python -m venv .venv
   ```

3. **Activate the environment**:
   - Windows Command Prompt: `.venv\Scripts\activate`
   - Windows PowerShell: `.venv\Scripts\Activate.ps1`
   - macOS/Linux: `source .venv/bin/activate`

4. **Install dependencies**:
   ```bash
   pip install -r requirements.txt
   # Optional DICOM codecs
   pip install pylibjpeg pylibjpeg-libjpeg
   ```

5. **Prepare data**:
   - Ensure the `archive/` directory exists at the project root.
   - Place patient folders (named with AccessionNumber) inside `archive/` containing `.dcm` files.
   - Add `train.csv` directly inside `archive/`.

## Running the Application

1. Activate your virtual environment.
2. From the repository root, run:
   ```bash
   python src/main.py
   ```
3. Follow the console prompts to perform backups, cleanup, and filtering.

## Keyboard Shortcuts

- **Up / Down** – Move to the previous/next patient folder.
- **Left / Right** – Switch between DICOM files within the folder.
- **Mouse Click** – Set the ROI center; a lime rectangle outlines the ROI.
- **Enter** – Save the current ROI as a PNG inside the folder.
- **Overlay Counter** – Displays `Image X/Y` in the lower-left corner.
- **Window Title** – Shows folder name, DICOM index, target, and laterality.
- **Sidebar** – Lists thumbnails of saved ROIs (PNG files).

## Troubleshooting

- **"Unable to decompress" or similar codec errors** – Install `pylibjpeg` and `pylibjpeg-libjpeg`.
- **"FileNotFoundError" for `archive` or `train.csv`** – Confirm the directory layout matches the structure above. The app expects `archive/` at the project root with `train.csv` inside it.

## Future Enhancements

- Zoom and pan support.
- Manual adjustment of window center/width.
- GUI for startup options instead of console prompts.
- Persist the last viewed folder/image.
- Scrollable sidebar for large numbers of PNGs.
- ROI shapes with variable size or non-square geometry.
